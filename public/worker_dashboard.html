<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkillConnect | Worker Dashboard & Live Jobs</title>
    
    <link rel="stylesheet" href="worker_dashboard2.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script>
        // ‚ö†Ô∏è USE YOUR LIVE FIREBASE PROJECT CONFIG DETAILS HERE ‚ö†Ô∏è
        const firebaseConfig = {
            apiKey: "AIzaSyD6Kn44-ilM8DoCrzUFwoVYyd4GmuDcsFE",
            authDomain: "skillconnect-f6632.firebaseapp.com",
            projectId: "skillconnect-f6632",
            storageBucket: "skillconnect-f6632.firebasestorage.app",
            messagingSenderId: "462430536837",
            appId: "1:462430536837:web:4e6a791ca9b462a29895ec",
            measurementId: "G-VY0EH70WR9"
        };

        // Initialize Firebase and Firestore
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        /**
         * Handles the click event for the Apply button.
         * Changes the button text and appearance for visual feedback.
         */
        function handleApplyClick(event) {
            const button = event.target;
            const jobId = button.closest('.job-card').getAttribute('data-job-id');

            // üí° Visual Feedback Update
            button.textContent = 'Applied Successfully! ‚úÖ';
            button.disabled = true;
            button.style.backgroundColor = '#155724'; // Darker success color
            button.style.cursor = 'default';

            console.log(`Application submitted for Job ID: ${jobId}`);

            // NOTE: In a real app, this is where you would send the worker's application data to a 'applications' collection.
        }

        /**
         * Attaches a single event listener (delegation) to handle all dynamically created 'Apply' buttons.
         */
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('apply-button')) {
                handleApplyClick(event);
            }
        });


        /**
         * Fetches job listings from the 'jobs' collection and renders them on the page.
         */
        function loadJobs() {
            const jobsContainer = document.getElementById('live-job-listings');
            jobsContainer.innerHTML = '<h2>Loading Job Opportunities...</h2>'; // Loading message

            db.collection("jobs").get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        jobsContainer.innerHTML = '<h2>No jobs currently posted. Check back soon!</h2>';
                        return;
                    }

                    // Clear loading message and prepare to build the list
                    jobsContainer.innerHTML = '';
                    
                    querySnapshot.forEach((doc) => {
                        const job = doc.data();
                        
                        // --- üí° Data Retrieval ---
                        const rawSkill = job.job_type || 'General Work';
                        const rawLevel = job.worker_level || 'N/A';
                        const rawDuration = job.duration_hrs || job.job_duration || 'N/A';
                        
                        // FIX: Retrieving 'calculated_wage' from the database
                        const offeredWage = job.calculated_wage; 
                        const wageType = job.wage_type || 'Total';
                        
                        const offeredWageValue = parseFloat(offeredWage) || 0; 
                        
                        const formattedWage = offeredWageValue > 0
                            ? `‚Çπ${offeredWageValue.toFixed(0)} (${wageType})` 
                            : 'Not Specified';
                        // --- üí° End Data Retrieval ---


                        // Construct the main job title string
                        const jobTitle = `${rawSkill} (Level ${rawLevel})`;

                        // Determine an icon based on job_type
                        let iconClass = 'fas fa-briefcase'; 
                        if (rawSkill.includes('Cook')) iconClass = 'fas fa-utensils';
                        else if (rawSkill.includes('Electrical')) iconClass = 'fas fa-bolt';
                        else if (rawSkill.includes('Development')) iconClass = 'fas fa-code';
                        
                        // Create the HTML structure for one job card
                        const cardHTML = `
                            <div class="job-card" data-job-id="${doc.id}">
                                <h3>
                                    ${jobTitle} 
                                    <i class="${iconClass} icon-right"></i>
                                </h3>
                                <p>${job.job_statement}</p>
                                
                                <div class="job-meta">
                                    <p><strong><i class="fas fa-wallet"></i> Wage:</strong> ${formattedWage}</p>
                                    <p><strong><i class="fas fa-map-marker-alt"></i> Location:</strong> ${job.job_location}</p>
                                    <p><strong><i class="fas fa-clock"></i> Duration:</strong> ${rawDuration} Hours</p>
                                    <p><strong><i class="fas fa-building"></i> Employer:</strong> ${job.employer_name}</p>
                                </div>
                                
                                <button class="apply-button">Apply</button>
                            </div>
                        `;
                        
                        // Add the card to the container
                        jobsContainer.innerHTML += cardHTML;
                    });
                })
                .catch((error) => {
                    console.error("Error loading jobs: ", error);
                    jobsContainer.innerHTML = '<h2>Failed to load jobs. Check console for error details.</h2>';
                });
        }
        
        // Load the jobs as soon as the page is ready
        window.onload = loadJobs;
    </script>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="logo">SkillConnect</h1>
            <nav class="main-nav">
                <ul>
                    
                    <li><a href="#messages">Messages</a></li>
                    <li><a href="#history">History</a></li>
                    <li><a href="#myjobs">My Jobs</a></li>
                    <li><a href="#applications">Applications</a></li>
                    <li><a href="employer_dashboard.html" class="nav-link">Employer Posts</a></li>
                    <button onclick="window.location.href='homepage.html';" style="background-color: #8b7454; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;">Logout</button>
                    <li class="profile-dropdown">
                        <a href="#profile" class="profile-icon">
                            <img src="https://via.placeholder.com/30/808080/FFFFFF?text=DP" alt="Profile Picture">
                            <i class="fas fa-caret-down"></i>
                            
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="main-content container">
        <h2 style="font-family: 'Poppins', sans-serif; color: #3a332d; border-bottom: 2px solid #e0d9cf; padding-bottom: 10px; margin-bottom: 20px;">Available Job Listings</h2>
        
        <div class="job-listings" id="live-job-listings">
        </div>
    </main>
</body>
</html>